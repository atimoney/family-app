// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// GOOGLE CALENDAR INTEGRATION
// ============================================================================

// Stores Google OAuth credentials per user (one user can have multiple Google accounts)
model GoogleAccount {
  id           String   @id @default(cuid())
  userId       String
  googleUserId String
  email        String?
  refreshToken String   // Encrypted refresh token
  scopes       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  selectedCalendars SelectedCalendar[]
  calendarEvents    CalendarEvent[]
  linkedTasks       Task[]

  @@unique([userId, googleUserId])
  @@index([userId])
}

// Tracks which calendars a user has selected to sync/view
model SelectedCalendar {
  id              String    @id @default(cuid())
  userId          String
  googleAccountId String
  calendarId      String    // Google Calendar ID (e.g., "primary", email address)
  summary         String    // Display name
  color           String?   // Calendar color from Google
  isVisible       Boolean   @default(true)
  syncToken       String?   // Google sync token for incremental sync
  lastSyncedAt    DateTime? // When this calendar was last synced
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  googleAccount  GoogleAccount   @relation(fields: [googleAccountId], references: [id], onDelete: Cascade)
  calendarEvents CalendarEvent[]

  @@unique([userId, calendarId])
  @@index([userId])
  @@index([googleAccountId])
}

// Local cache of calendar events synced from Google
model CalendarEvent {
  id              String    @id @default(cuid())
  userId          String
  googleAccountId String
  calendarId      String    // References SelectedCalendar.calendarId
  googleEventId   String    // Google's event ID
  startsAt        DateTime
  endsAt          DateTime
  title           String
  description     String?
  location        String?
  allDay          Boolean   @default(false)
  status          String?   // confirmed, tentative, cancelled
  recurringEventId String?  // For recurring event instances
  rawJson         Json?     // Store full Google event for reference
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  googleAccount    GoogleAccount          @relation(fields: [googleAccountId], references: [id], onDelete: Cascade)
  selectedCalendar SelectedCalendar       @relation(fields: [userId, calendarId], references: [userId, calendarId], onDelete: Cascade)
  metadata         CalendarEventMetadata?

  @@unique([userId, googleEventId])
  // Note: Removed @@unique([calendarId, googleEventId]) to allow multiple users to sync the same shared calendar
  @@index([userId, startsAt])
  @@index([userId, endsAt])
  @@index([userId, calendarId, startsAt])
  @@index([googleAccountId])
  @@index([calendarId])
}

// User-defined metadata for calendar events (tags, notes, colors, etc.)
model CalendarEventMetadata {
  id               String   @id @default(cuid())
  eventId          String   @unique
  tags             String[]
  notes            String?
  color            String?  // User override color
  customJson       Json     @default("{}")
  // E1: Event metadata fields
  category         String?  // E1: Event category (Meal, School, Sport, etc.)
  audience         String?  @default("family") // E1: Target audience (family, adults, kids)
  categoryMetadata Json     @default("{}") // E1: Category-specific metadata
  deletedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([category])
}

// Stores extra data for events (legacy - kept for migration, prefer CalendarEventMetadata)
model EventLink {
  id         String   @id @default(cuid())
  userId     String
  calendarId String
  eventId    String
  extraData  Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, calendarId, eventId])
  @@index([userId, calendarId])
}

// ============================================================================
// FAMILY APP FEATURES
// ============================================================================

// User profile - keyed by Supabase auth.users.id
model Profile {
  id          String   @id // UUID from Supabase auth.users.id
  email       String
  displayName String?  @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  timezone    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdFamilies Family[]       @relation("FamilyCreator")
  memberships     FamilyMember[]
  sentInvites     FamilyInvite[] @relation("InviteSender")

  @@map("profiles")
}

// A family unit that members belong to
model Family {
  id               String   @id @default(cuid())
  name             String
  createdBy        String   @map("created_by")
  sharedCalendarId String?  @map("shared_calendar_id") // Google Calendar ID for family shared calendar
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  creator         Profile         @relation("FamilyCreator", fields: [createdBy], references: [id])
  members         FamilyMember[]
  invites         FamilyInvite[]
  eventCategories EventCategory[]
  tasks           Task[]
  taskTemplates   TaskTemplate[]
  lists           List[]

  @@index([createdBy])
  @@map("families")
}

// A member within a family
model FamilyMember {
  id          String    @id @default(cuid())
  familyId    String    @map("family_id")
  profileId   String    @map("profile_id")
  role        String    @default("member") // owner, admin, member
  displayName String?   @map("display_name") // Family-specific name override
  color       String?   // For calendar/UI color coding
  isChild     Boolean   @default(false) @map("is_child") // Whether this member is a child
  joinedAt    DateTime  @default(now()) @map("joined_at")
  removedAt   DateTime? @map("removed_at")
  removedBy   String?   @map("removed_by")

  // Relations
  family  Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Task relations
  assignedTasks             Task[]         @relation("TaskAssignee")
  createdTasks              Task[]         @relation("TaskCreator")
  templateDefaultAssignments TaskTemplate[] @relation("TemplateDefaultAssignee")

  // Unique active membership per family
  @@unique([familyId, profileId])
  @@index([profileId])
  @@index([familyId])
  @@map("family_members")
}

// An invitation to join a family
model FamilyInvite {
  id          String    @id @default(cuid())
  familyId    String    @map("family_id")
  email       String?   // If set, only this email can accept
  role        String    @default("member") // admin, member (not owner)
  token       String    @unique
  invitedBy   String    @map("invited_by")
  status      String    @default("pending") // pending, accepted, declined, expired, revoked
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime  @map("expires_at")
  respondedAt DateTime? @map("responded_at")

  // Relations
  family  Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  inviter Profile @relation("InviteSender", fields: [invitedBy], references: [id])

  @@index([familyId, status])
  @@index([token])
  @@map("family_invites")
}

model Task {
  id                String    @id @default(cuid())
  familyId          String    @map("family_id")
  title             String
  description       String?
  status            String    @default("todo") // todo, doing, done
  priority          String    @default("medium") // low, medium, high, urgent
  
  // Time anchors
  dueAt             DateTime? @map("due_at")
  completedAt       DateTime? @map("completed_at")
  
  // Assignment
  assignedToUserId  String?   @map("assigned_to_user_id") // FamilyMember.id
  createdByUserId   String    @map("created_by_user_id")  // FamilyMember.id
  
  // Recurrence fields
  isRecurring       Boolean   @default(false) @map("is_recurring")
  recurrenceRule    Json?     @map("recurrence_rule") // RRULE-like JSON: {frequency, interval, byDay, etc.}
  parentTaskId      String?   @map("parent_task_id") // For generated instances, points to the recurring parent
  recurrenceIndex   Int?      @map("recurrence_index") // Which occurrence this is (0, 1, 2, ...)
  
  // Calendar linking (MVP 5)
  linkedCalendarEventId   String?   @map("linked_calendar_event_id") // Google Calendar event ID
  linkedCalendarId        String?   @map("linked_calendar_id") // Calendar ID the event is on
  linkedGoogleAccountId   String?   @map("linked_google_account_id") // GoogleAccount.id
  
  // Metadata
  labels            String[]  @default([])
  sortOrder         Int       @default(0) @map("sort_order")
  
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  family            Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  assignedTo        FamilyMember? @relation("TaskAssignee", fields: [assignedToUserId], references: [id])
  createdBy         FamilyMember  @relation("TaskCreator", fields: [createdByUserId], references: [id])
  parentTask        Task?         @relation("TaskRecurrence", fields: [parentTaskId], references: [id])
  childTasks        Task[]        @relation("TaskRecurrence")
  linkedGoogleAccount GoogleAccount? @relation(fields: [linkedGoogleAccountId], references: [id])

  @@index([familyId, status])
  @@index([familyId, dueAt])
  @@index([familyId, assignedToUserId])
  @@index([familyId, deletedAt])
  @@index([parentTaskId])
  @@index([linkedGoogleAccountId])
  @@map("tasks")
}

// Task template for quick task creation
model TaskTemplate {
  id                 String    @id @default(cuid())
  familyId           String    @map("family_id")
  name               String    // Template name (e.g., "Weekly Chores", "School Homework")
  
  // Task defaults
  title              String    // Default task title
  description        String?
  priority           String    @default("medium") // low, medium, high, urgent
  labels             String[]  @default([])
  
  // Optional default assignee
  defaultAssigneeId  String?   @map("default_assignee_id") // FamilyMember.id
  
  // Due date pattern (relative to creation)
  dueDaysFromNow     Int?      @map("due_days_from_now") // e.g., 1 = tomorrow, 7 = next week
  dueTimeOfDay       String?   @map("due_time_of_day") // e.g., "09:00" for morning tasks
  
  // Metadata
  icon               String?   // Optional icon for UI
  color              String?   // Optional color for UI
  sortOrder          Int       @default(0) @map("sort_order")
  usageCount         Int       @default(0) @map("usage_count") // Track how often template is used
  
  deletedAt          DateTime? @map("deleted_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  family             Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  defaultAssignee    FamilyMember? @relation("TemplateDefaultAssignee", fields: [defaultAssigneeId], references: [id])

  @@unique([familyId, name])
  @@index([familyId, sortOrder])
  @@index([familyId, deletedAt])
  @@map("task_templates")
}

model ShoppingItem {
  id        String   @id @default(cuid())
  name      String
  quantity  String?
  category  String?
  purchased Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// EVENT CATEGORIES (E1)
// ============================================================================

// Custom event categories per family
model EventCategory {
  id             String    @id @default(cuid())
  familyId       String    @map("family_id")
  name           String    // Internal name (e.g., "meal", "sport") - used as key
  label          String    // Display label (e.g., "Meal", "Sport")
  icon           String    // Iconify icon name (e.g., "solar:cup-star-bold")
  color          String?   // Optional hex color for category
  sortOrder      Int       @default(0) @map("sort_order")
  isSystem       Boolean   @default(false) @map("is_system") // System categories can't be deleted
  metadataSchema Json      @default("{}") @map("metadata_schema") // JSON schema for category-specific fields
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, name])
  @@index([familyId, sortOrder])
  @@map("event_categories")
}

// ============================================================================
// LISTS (Generic list primitive - shopping, meal plans, custom)
// ============================================================================

// A family list (shopping, meal plan, or custom)
model List {
  id            String   @id @default(cuid())
  familyId      String   @map("family_id")
  name          String
  templateKey   String   @map("template_key") // shopping, meal_plan, custom
  navVisibility String   @default("visible") @map("nav_visibility") // pinned, visible, hidden
  config        Json     @default("{}") // ListConfig: fields, views, etc.
  icon          String?  // Optional icon identifier
  color         String?  // Optional color
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  family      Family               @relation(fields: [familyId], references: [id], onDelete: Cascade)
  items       ListItem[]
  preferences UserListPreferences[]

  @@index([familyId])
  @@map("lists")
}

// An item within a list
model ListItem {
  id               String    @id @default(cuid())
  listId           String    @map("list_id")
  title            String
  status           String    @default("open") // open, done, archived
  sortOrder        Int       @default(0) @map("sort_order")
  dueAt            DateTime? @map("due_at")
  assignedToUserId String?   @map("assigned_to_user_id") // Profile ID
  fields           Json      @default("{}") // Dynamic field values based on list config
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  list List @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId, status])
  @@index([listId, sortOrder])
  @@map("list_items")
}

// User-specific preferences for a list (view state, filters, etc.)
model UserListPreferences {
  userId      String   @map("user_id") // Profile ID
  listId      String   @map("list_id")
  lastViewKey String?  @map("last_view_key") // Last selected view (list, table, grouped, week)
  prefs       Json     @default("{}") // {sort, filters, collapsedGroups, etc.}
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  list List @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@id([userId, listId])
  @@map("user_list_preferences")
}

// ============================================================================
// AGENT AUDIT LOG
// ============================================================================

// Audit log for agent tool invocations
model AgentAuditLog {
  id          String   @id @default(cuid())
  requestId   String   @map("request_id")
  userId      String   @map("user_id")
  familyId    String   @map("family_id")
  toolName    String   @map("tool_name")
  input       Json     // Tool input (sensitive fields redacted)
  output      Json?    // Tool output (optional, for debugging)
  success     Boolean
  errorMessage String? @map("error_message")
  executionMs Int?     @map("execution_ms")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([familyId, createdAt])
  @@index([toolName, createdAt])
  @@index([requestId])
  @@map("agent_audit_logs")
}
