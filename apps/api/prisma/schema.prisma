// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// GOOGLE CALENDAR INTEGRATION
// ============================================================================

// Stores Google OAuth credentials per user (one user can have multiple Google accounts)
model GoogleAccount {
  id           String   @id @default(cuid())
  userId       String
  googleUserId String
  email        String?
  refreshToken String   // Encrypted refresh token
  scopes       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  selectedCalendars SelectedCalendar[]
  calendarEvents    CalendarEvent[]

  @@unique([userId, googleUserId])
  @@index([userId])
}

// Tracks which calendars a user has selected to sync/view
model SelectedCalendar {
  id              String    @id @default(cuid())
  userId          String
  googleAccountId String
  calendarId      String    // Google Calendar ID (e.g., "primary", email address)
  summary         String    // Display name
  color           String?   // Calendar color from Google
  isVisible       Boolean   @default(true)
  syncToken       String?   // Google sync token for incremental sync
  lastSyncedAt    DateTime? // When this calendar was last synced
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  googleAccount  GoogleAccount   @relation(fields: [googleAccountId], references: [id], onDelete: Cascade)
  calendarEvents CalendarEvent[]

  @@unique([userId, calendarId])
  @@index([userId])
  @@index([googleAccountId])
}

// Local cache of calendar events synced from Google
model CalendarEvent {
  id              String    @id @default(cuid())
  userId          String
  googleAccountId String
  calendarId      String    // References SelectedCalendar.calendarId
  googleEventId   String    // Google's event ID
  startsAt        DateTime
  endsAt          DateTime
  title           String
  description     String?
  location        String?
  allDay          Boolean   @default(false)
  status          String?   // confirmed, tentative, cancelled
  recurringEventId String?  // For recurring event instances
  rawJson         Json?     // Store full Google event for reference
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  googleAccount    GoogleAccount          @relation(fields: [googleAccountId], references: [id], onDelete: Cascade)
  selectedCalendar SelectedCalendar       @relation(fields: [userId, calendarId], references: [userId, calendarId], onDelete: Cascade)
  metadata         CalendarEventMetadata?

  @@unique([userId, googleEventId])
  // Note: Removed @@unique([calendarId, googleEventId]) to allow multiple users to sync the same shared calendar
  @@index([userId, startsAt])
  @@index([userId, endsAt])
  @@index([userId, calendarId, startsAt])
  @@index([googleAccountId])
  @@index([calendarId])
}

// User-defined metadata for calendar events (tags, notes, colors, etc.)
model CalendarEventMetadata {
  id               String   @id @default(cuid())
  eventId          String   @unique
  tags             String[]
  notes            String?
  color            String?  // User override color
  customJson       Json     @default("{}")
  // E1: Event metadata fields
  category         String?  // E1: Event category (Meal, School, Sport, etc.)
  audience         String?  @default("family") // E1: Target audience (family, adults, kids)
  categoryMetadata Json     @default("{}") // E1: Category-specific metadata
  deletedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([category])
}

// Stores extra data for events (legacy - kept for migration, prefer CalendarEventMetadata)
model EventLink {
  id         String   @id @default(cuid())
  userId     String
  calendarId String
  eventId    String
  extraData  Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, calendarId, eventId])
  @@index([userId, calendarId])
}

// ============================================================================
// FAMILY APP FEATURES
// ============================================================================

// User profile - keyed by Supabase auth.users.id
model Profile {
  id          String   @id // UUID from Supabase auth.users.id
  email       String
  displayName String?  @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  timezone    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdFamilies Family[]       @relation("FamilyCreator")
  memberships     FamilyMember[]
  sentInvites     FamilyInvite[] @relation("InviteSender")

  @@map("profiles")
}

// A family unit that members belong to
model Family {
  id        String   @id @default(cuid())
  name      String
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator         Profile         @relation("FamilyCreator", fields: [createdBy], references: [id])
  members         FamilyMember[]
  invites         FamilyInvite[]
  eventCategories EventCategory[]

  @@index([createdBy])
  @@map("families")
}

// A member within a family
model FamilyMember {
  id          String    @id @default(cuid())
  familyId    String    @map("family_id")
  profileId   String    @map("profile_id")
  role        String    @default("member") // owner, admin, member
  displayName String?   @map("display_name") // Family-specific name override
  color       String?   // For calendar/UI color coding
  joinedAt    DateTime  @default(now()) @map("joined_at")
  removedAt   DateTime? @map("removed_at")
  removedBy   String?   @map("removed_by")

  // Relations
  family  Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Unique active membership per family
  @@unique([familyId, profileId])
  @@index([profileId])
  @@index([familyId])
  @@map("family_members")
}

// An invitation to join a family
model FamilyInvite {
  id          String    @id @default(cuid())
  familyId    String    @map("family_id")
  email       String?   // If set, only this email can accept
  role        String    @default("member") // admin, member (not owner)
  token       String    @unique
  invitedBy   String    @map("invited_by")
  status      String    @default("pending") // pending, accepted, declined, expired, revoked
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime  @map("expires_at")
  respondedAt DateTime? @map("responded_at")

  // Relations
  family  Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  inviter Profile @relation("InviteSender", fields: [invitedBy], references: [id])

  @@index([familyId, status])
  @@index([token])
  @@map("family_invites")
}

model Task {
  id         String    @id @default(cuid())
  title      String
  assigneeId String?
  dueDate    DateTime?
  status     String    @default("todo")
  completed  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model ShoppingItem {
  id        String   @id @default(cuid())
  name      String
  quantity  String?
  category  String?
  purchased Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// EVENT CATEGORIES (E1)
// ============================================================================

// Custom event categories per family
model EventCategory {
  id             String    @id @default(cuid())
  familyId       String    @map("family_id")
  name           String    // Internal name (e.g., "meal", "sport") - used as key
  label          String    // Display label (e.g., "Meal", "Sport")
  icon           String    // Iconify icon name (e.g., "solar:cup-star-bold")
  color          String?   // Optional hex color for category
  sortOrder      Int       @default(0) @map("sort_order")
  isSystem       Boolean   @default(false) @map("is_system") // System categories can't be deleted
  metadataSchema Json      @default("{}") @map("metadata_schema") // JSON schema for category-specific fields
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, name])
  @@index([familyId, sortOrder])
  @@map("event_categories")
}
